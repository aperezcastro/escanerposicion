<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mapa de mi casa</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
    </style>
</head>
<body>
<canvas id="canvas"></canvas>
<script>
    // Obtener el canvas y ajustar su tamaño
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let width = canvas.width = window.innerWidth;
    let height = canvas.height = window.innerHeight;

    // Posición inicial en el centro del canvas
    let x = width / 2;
    let y = height / 2;

    let lastTime = null;
    let vx = 0, vy = 0;
    let ax = 0, ay = 0;
    let orientation = 0;
    let scale = 50; // Ajusta este valor para cambiar la escala en metros
    let alpha = 0.9; // Factor para el filtro complementario

    // Solicitar permiso para acceder a los sensores (iOS 13+)
    function requestPermissions() {
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
            DeviceMotionEvent.requestPermission()
                .then(response => {
                    if (response == 'granted') {
                        window.addEventListener('devicemotion', handleMotion);
                    } else {
                        alert('Permiso denegado para acceder al acelerómetro.');
                    }
                })
                .catch(console.error);
        } else {
            window.addEventListener('devicemotion', handleMotion);
        }

        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response == 'granted') {
                        window.addEventListener('deviceorientationabsolute', handleOrientation);
                    } else {
                        alert('Permiso denegado para acceder al giroscopio.');
                    }
                })
                .catch(console.error);
        } else {
            window.addEventListener('deviceorientationabsolute', handleOrientation);
        }
    }

    requestPermissions();

    function handleOrientation(event) {
        // Usar la orientación absoluta para obtener el ángulo respecto al norte verdadero
        if (event.absolute) {
            orientation = event.alpha || 0; // En grados
        }
    }

    function handleMotion(event) {
        let currentTime = Date.now();
        if (lastTime) {
            let dt = (currentTime - lastTime) / 1000; // Convertir a segundos

            // Aceleración sin gravedad
            let axRaw = event.acceleration.x || 0;
            let ayRaw = event.acceleration.y || 0;

            // Aplicar filtro complementario
            ax = alpha * ax + (1 - alpha) * axRaw;
            ay = alpha * ay + (1 - alpha) * ayRaw;

            // Convertir orientación a radianes
            let angleRad = orientation * Math.PI / 180;

            // Rotar la aceleración al marco de referencia global
            let axGlobal = ax * Math.cos(angleRad) - ay * Math.sin(angleRad);
            let ayGlobal = ax * Math.sin(angleRad) + ay * Math.cos(angleRad);

            // Integrar la aceleración para obtener la velocidad
            vx += axGlobal * dt;
            vy += ayGlobal * dt;

            // Integrar la velocidad para obtener la posición
            x += vx * dt * scale;
            y += vy * dt * scale;

            // Dibujar la línea
            ctx.lineTo(x, y);
            ctx.strokeStyle = 'blue';
            ctx.lineWidth = 2;
            ctx.stroke();
        } else {
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        lastTime = currentTime;
    }
</script>
</body>
</html>
